 <!DOCTYPE html>
 <html>
   <head>

     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">

     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.4/semantic.min.css" type="text/css">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/solarized-light.min.css" rel="stylesheet" />

     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.4/semantic.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

      <style>
        

body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

figcaption
{
  margin-bottom: 20px;
}

.vertical-align
{
  display: flex;
  align-items: center;
}



    </style>

  </head>

  <body>
    

<style>
  

code
{
  font-family: "Monaco";
  font-size: 110%;
}

img
{
  padding:1px;
  border:1px solid black;
}

h1
{
  font-style:italic;
  font-size:130%;
  border-bottom: thin solid black;
}
h2
{
  font-size:110%;
  border-bottom: thin solid black;
}
h3
{
  font-size:100%;
  border-bottom: thin solid black;
}



</style>

<div class="ui fixed top pointing inverted menu labmenu">
  <header class="header item">
    <i id="toc" class="sitemap icon"></i>
    <a href="../index.html">
      2: Node.js
    </a>
  </header>
  <div class="right tab-menu menu">
    
    <a class="item" data-tab="Lab-03">
      Lab-03
    </a>
    
    <a class="item" data-tab="01">
      01
    </a>
    
    <a class="item" data-tab="02">
      02
    </a>
    
    <a class="item" data-tab="03">
      03
    </a>
    
    <a class="item" data-tab="04">
      04
    </a>
    
    <a class="item" data-tab="05">
      05
    </a>
    
    <a class="item" data-tab="06">
      06
    </a>
    
    <a class="item" data-tab="Solution">
      Solution
    </a>
    
    <a class="item" data-tab=".">
      .
    </a>
    
    <a class="item" href="../../index.html">
      <i class="home icon"></i>
    </a>
  </div>
</div>

<div class="ui segment pushable">
  <div class="ui inverted labeled icon left inline vertical sidebar menu">
    
      
        <a class="item" href="../../topic01-intro/book-a-lab00/index.html">
          Setup
        </a>
      
    
      
        <a class="item" href="../../topic02-node/book-a-lab01/index.html">
          Lab-01
        </a>
      
    
      
        <a class="item" href="../../topic02-node/book-b-lab02/index.html">
          Lab-02
        </a>
      
    
      
        <a class="active item" href="../../topic02-node/book-c-lab03/index.html">
          Lab-03
        </a>
      
    
      
        <a class="item" href="../../topic03-angular/book-d-lab04/index.html">
          Lab-04
        </a>
      
    
      
        <a class="item" href="../../topic03-angular/book-e-lab05/index.html">
          Lab-05
        </a>
      
    
      
        <a class="item" href="../../topic03-angular/book-f-heroku/index.html">
          Deploy-to-Heroku
        </a>
      
    
  </div>
  <div class="pusher">
    <div class="ui basic segment">
      <br>
      
      <div  class="ui tab segment lab" data-tab="Lab-03">
        <h1>Lab 3 - Donation 2.0 (Mongo, Express &amp; Node App)</h1>
<p>In this lab we will be introducing some proper persistence, through a <strong>MongoDB</strong> backend, and if we have time, deploying our <strong><em>local web server</em></strong> to <strong><em>heroku</em></strong> so that everyone can see our web app!</p>
<p>Here&#39;s a link to some of the commands you&#39;ll be using throughout the lab [QuickLinks] docs.mongodb.org/master/tutorial/getting-started-with-the-mongo-shell/ but most of what we do in this lab we&#39;ll have covered in the lectures.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="01">
        <h1>Objectives</h1>
<p>In this Lab, you will be required to build the next version of our Donation Case Study Web App, called <strong>DonationWeb 2.0</strong>.  We will build on the previous lab, so you can either use your own version of <strong>DonationWeb 1.0</strong> or download the starter code <strong><a href="../zips/donationweb-1.0.zip">here</a></strong>. In this version we will be implementing a <strong><em>MongoDB</em></strong> backend (and reusing our previous solution).  </p>
<p>On completion of this lab you&#39;ll be able to</p>
<ul>
<li>create a <strong>NodeJS</strong> web app using <strong>express</strong> </li>
<li>run this app as a <strong>NodeJS Server</strong> and process client requests</li>
<li>be able to use <strong>npm</strong> to install dependency modules</li>
</ul>
<p>AND</p>
<ul>
<li>store data in a <strong>MongoDB</strong> database</li>
</ul>

      </div>
     
      <div  class="ui tab segment lab" data-tab="02">
        <h1>Step 2 - Setup</h1>
<p>First thing you should do is download the starter code (or the solution to the previous lab) <strong><a href="../zips/donationweb-1.0.zip">here</a></strong> and then extract it to your single parent folder for all your web app projects you created for previous labs. </p>
<p>Rename the extracted folder, (or copy your own version) to <strong>donationweb-2.0</strong></p>
<p>Open your <strong>donationweb-2.0</strong> web app (in WebStorm) </p>
<p><img src="../lab03/images/lab02s213.png" alt=""></p>
<p>and then change your &#39;title&#39; like so</p>
<p><img src="../lab03/images/lab02s214.png" alt=""></p>
<p>and launch it.</p>
<p>You may not get any errors, but you should probably reconfigure your project (as it&#39;s a copy) and fix the <strong>node modules</strong> path as follows:</p>
<p>Open your preferences and navigate to the <strong>Library</strong> settings</p>
<p><img src="../lab03/images/lab02s211.png" alt=""></p>
<p>and</p>
<p>update your <strong>node_modules</strong> path to point to the current project</p>
<p><img src="../lab03/images/lab02s212.png" alt=""></p>
<p>Launch it again, if everything goes to plan you should be able to visit <a href="http://localhost:3000"><a href="http://localhost:3000">http://localhost:3000</a></a> and you should see the following</p>
<p><img src="../lab03/images/lab02s215.png" alt=""></p>
<p>The next thing to do is to add the <strong>mongodb</strong> and <strong>mongoose</strong> module dependencies to our project. Launch the terminal window </p>
<p><img src="../lab03/images/lab02s216.png" alt=""></p>
<p>and run the following commands</p>
<pre><code>npm install mongoose</code></pre>
<p>and</p>
<pre><code>npm install mongodb</code></pre>
<p>Your project should now look like this</p>
<p><img src="../lab03/images/lab02s217.png" alt=""></p>
<p>The last step in our &#39;Setup&#39; is to kick off our localhost mongodb server and insert a few &#39;Donations&#39; so we can test our refactored &#39;findAll&#39; function (next step).</p>
<p>Open up a terminal window and launch the mongodb server</p>
<p><img src="../lab03/images/lab02s201.png" alt=""></p>
<p>Open another, separate window and launch the client</p>
<p><img src="../lab03/images/lab02s202.png" alt=""></p>
<p>In the client window, create/switch to the &#39;donationsdb&#39; database</p>
<p><img src="../lab03/images/lab02s203.png" alt=""></p>
<p>Insert a few records and make sure you name your collection <strong>donations</strong> and <strong>NOT</strong> donationsdb, (as in the screenshots), so you&#39;ll be saying something like</p>
<pre><code>db.donations.find()</code></pre>
<p>etc. etc.</p>
<p><img src="../lab03/images/lab02s204.png" alt=""></p>
<p>&#39;Find&#39; all the donations, just to confirm they exist.</p>
<p><img src="../lab03/images/lab02s205.png" alt=""></p>
<p>We now have a few records or &#39;documents&#39; we can access via our Node Web Server (next step).</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="03">
        <h1>Step 3 - Creating our Database Schema</h1>
<p>Our first step in making a persistent data store is to configure our data models. To do this, we are going to be adding a schema layer on top of <strong>MongoDB</strong> using a nice library called <strong><em>Mongoose</em></strong>. Before we begin, let&#39;s make sure our <strong>MongoDB</strong> server is running.</p>
<p>If Mongo isn&#39;t running on your machine, enter this into your terminal:</p>
<pre><code>mongod</code></pre>
<p>and to run a mongo client</p>
<pre><code>mongo</code></pre>
<p>We connect to our local MongoDB instance by adding the following code into our donations.js <strong>routes</strong> file:</p>
<pre><code class="lang-javascript">var mongoose = require(&#39;mongoose&#39;); 

...

mongoose.connect(&#39;mongodb://localhost:27017/donationsdb&#39;);

var db = mongoose.connection;

db.on(&#39;error&#39;, function (err) {
    console.log(&#39;connection error&#39;, err);
});
db.once(&#39;open&#39;, function () {
    console.log(&#39;connected to database&#39;);
});</code></pre>
<p>(It&#39;s probably a good idea to remove our javascript list altogether at this point as we don&#39;t need it.)</p>
<p>This will open a connection with the <strong><em>donationsdb</em></strong> database running on our Mongo server. Now we can modify our existing model and introduce a database schema.</p>
<hr>
<h2>Creating a Schema with Mongoose</h2>
<p>In our <strong>models/</strong> directory edit <strong>donations.js</strong> and replace the current &#39;model&#39; with the following code:</p>
<pre><code class="lang-javascript">var mongoose = require(&#39;mongoose&#39;);

var DonationSchema = new mongoose.Schema({
  paymenttype: String,
  amount: Number,
  upvotes: {type: Number, default: 0}
});

module.exports = mongoose.model(&#39;Donation&#39;, DonationSchema);</code></pre>
<p>Here we&#39;ve defined a model called <strong><em>Donation</em></strong> with several attributes corresponding to the type of data we&#39;d like to store. We&#39;ve declared our upvotes field to be initialized to 0.</p>
<p>Next we register that model with the global mongoose object we imported using require() so that it can be used to interact with the database anywhere else mongoose is imported.</p>
<p><strong>It is strongly recommended to run your web server at this point, to ensure everything is configured correctly and before we go ahead an modify our routes to interact with the database.</strong></p>
<p>So as before, go ahead and fire up the server - but make sure your mongodb is running first, and you get the <strong>&#39;connected to database&#39;</strong> message at the console.</p>
<p><img src="../lab03/images/lab02s218.png" alt=""></p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="04">
        <h1>Step 4 - Modifying our &#39;Routes&#39;, Part 1 ( &#39;findAll&#39; &amp; &#39;findOne&#39; )</h1>
<p>Our current setup involves pulling data from a javascript object array and storing objects back to that array. We now want to be able to store and retrieve our <strong><em>&#39;donations&#39;</em></strong> from our mongodb database.</p>
<p>The first thing we&#39;ll do is modify our &#39;findAll&#39; route.</p>
<hr>
<h2>Modifying Our First Route - &#39;findAll&#39;</h2>
<p>Edit your <strong>routes/donations.js</strong> file and navigate to your existing &#39;findAll&#39; function.</p>
<p>Now, replace it with the following :</p>
<pre><code class="lang-javascript">router.findAll = function(req, res) {
  // Use the Donation model to find all donations
  Donation.find(function(err, donations) {
    if (err)
      res.send(err);

    res.json(donations);
  });
}</code></pre>
<p>Notice how we use the Mongoose &#39;find&#39; function to retrieve all the objects from the &#39;Model&#39;.</p>
<p>Make sure you have the proper <strong>requires</strong> statement in your routes file</p>
<pre><code class="lang-javascript">var Donation = require(&#39;../models/donations&#39;);</code></pre>
<p>to include the mongoose schema.</p>
<hr>
<h3>Testing Our &#39;findAll&#39; Route</h3>
<h3>The Request</h3>
<p>GETing all the donations in our mongodb database</p>
<pre><code class="lang-html">/donations</code></pre>
<p><img src="../lab03/images/lab03s401.png" alt=""></p>
<h3>The Response</h3>
<p><img src="../lab03/images/lab03s402.png" alt=""></p>
<hr>
<h2>Modifying Our Second Route - &#39;findOne&#39;</h2>
<p>Our first route returned all the donations to a client, but what if the client only want&#39;s to get at a single donation from the database - that&#39;s what our next route &#39;findOne&#39; does, so we need to refactor our current implementation to make use of mongoose.</p>
<pre><code class="lang-javascript">router.findOne = function(req, res) {

    // Use the Donation model to find a single donation
    Donation.find({ &quot;_id&quot; : req.params.id },function(err, donation) {
        if (err)
            res.json({ message: &#39;Donation NOT Found!&#39;, errmsg : err } );
        else
            res.json(donation);
    });
}</code></pre>
<p>Notice the use of the <strong>req</strong> parameter to pass in the <strong><em>id</em></strong> of the donation we require.</p>
<hr>
<h3>Testing Our &#39;findOne&#39; Route</h3>
<h3>The Request</h3>
<p>GETing donation with id &#39;566594b787282d5d60eedc23&#39;</p>
<pre><code class="lang-html">/donations/566594b787282d5d60eedc23</code></pre>
<p><img src="../lab03/images/lab03s403.png" alt=""></p>
<h3>The Response</h3>
<p><img src="../lab03/images/lab03s403a.png" alt=""></p>
<p>requesting donation with id &#39;566594b787282d5d60eedc<strong>233</strong>&#39;</p>
<pre><code class="lang-html">/donations/566594b787282d5d60eedc233</code></pre>
<p><img src="../lab03/images/lab03s404.png" alt=""></p>
<hr>

      </div>
     
      <div  class="ui tab segment lab" data-tab="05">
        <h1>Step 5 - Modifying our &#39;Routes&#39;, Part 2 ( &#39;addDonation&#39;, &#39;deleteDonation&#39; &amp; &#39;incrementVotes&#39; )</h1>
<h2>Modifying Our Third Route - &#39;Add a Donation&#39;</h2>
<p>Again, edit your <strong>routes/donations.js</strong> file and navigate to your existing &#39;addDonation&#39; function.</p>
<p>And replace it with the following :</p>
<pre><code class="lang-javascript">router.addDonation = function(req, res) {

    var donation = new Donation();

    donation.paymenttype = req.body.paymenttype;
    donation.amount = req.body.amount;

    console.log(&#39;Adding donation: &#39; + JSON.stringify(donation));

    // Save the donation and check for errors
  donation.save(function(err) {
    if (err)
      res.send(err);

      res.json({ message: &#39;Donation Added!&#39;, data: donation });
  });
}</code></pre>
<p>There&#39;s a bit more going on here, so make sure you understand the general jist of how this works. (But I&#39;ll explain in the labs anyway)</p>
<p>You may need to restart your server but if everything goes to plan, you should now be able to store and retrieve &#39;donations&#39; from your mongodb database.</p>
<p>Let&#39;s test our <strong>addDonation</strong> using WebStorms REST Client (like before)</p>
<hr>
<h3>Testing Our &#39;Add&#39; Route</h3>
<h3>The Request</h3>
<p><img src="../lab02/images/lab02s27.png" alt=""></p>
<p>We need to fill in the <strong>Request Body</strong> for our POST</p>
<p><img src="../lab02/images/lab02s28.png" alt=""></p>
<p>POSTing donation data in JSON format</p>
<pre><code class="lang-json">{ &quot;paymenttype&quot;:&quot;Direct&quot;,&quot;amount&quot;:500 }</code></pre>
<p><img src="../lab03/images/lab02s501.png" alt=""></p>
<h3>The Response</h3>
<p><img src="../lab03/images/lab02s502.png" alt=""></p>
<p>GET all donations again to confirm</p>
<p><img src="../lab03/images/lab02s503.png" alt=""></p>
<hr>
<h2>Modifying Our Fourth Route - &#39;Delete a Donation&#39;</h2>
<p>Edit your <strong>routes/donations.js</strong> file and navigate to your existing &#39;deleteDonation&#39; function.</p>
<p>Now, replace it with the following :</p>
<pre><code class="lang-javascript">router.deleteDonation = function(req, res) {

    Donation.findByIdAndRemove(req.params.id, function(err) {
        if (err)
            res.send(err);
        else
            res.json({ message: &#39;Donation Deleted!&#39;});
    });
}</code></pre>
<p>Notice how we use the Mongoose <strong>&#39;findByIdAndRemove&#39;</strong> function to retrieve and delete the object from the &#39;Model&#39;.</p>
<hr>
<h3>Testing Our &#39;Delete&#39; Route</h3>
<p>DELETEing donation with id &#39;566594b787282d5d60eedc23&#39;</p>
<pre><code class="lang-html">/donations/566594b787282d5d60eedc23</code></pre>
<h3>The Request</h3>
<p><img src="../lab03/images/lab02s504.png" alt=""></p>
<h3>The Response</h3>
<p><img src="../lab03/images/lab02s505.png" alt=""></p>
<p>GET all donations again to confirm</p>
<p><img src="../lab03/images/lab02s506.png" alt=""></p>
<hr>
<h2>Modifying Our Fifth (and final) Route - &#39;Increment Votes&#39;</h2>
<p>Again, edit your <strong>routes/donations.js</strong> file and navigate to your existing &#39;incrementVotes&#39; function.</p>
<p>And replace it with the following :</p>
<pre><code class="lang-javascript">router.incrementUpvotes = function(req, res) {

    Donation.findById(req.params.id, function(err,donation) {
        if (err)
            res.send(err);
        else {
            donation.upvotes += 1;
            donation.save(function (err) {
                if (err)
                    res.send(err);
                else
                res.json({ message: &#39;Donation Upvoted!&#39;, data: donation });
            });
        }
    });
}</code></pre>
<p>Like last time, there&#39;s a bit more going on here, so make sure you understand the general jist of how this works. (But I&#39;ll explain in the labs if necessary?)</p>
<p>You may need to restart your server but if everything goes to plan, you might now be able to delete and &#39;upvote&#39; donations from your mongodb database.</p>
<hr>
<h3>Testing Our &#39;UpVote&#39; Route</h3>
<p>PUTing (or updating) donation with id &#39;566593d087282d5d60eedc22&#39;</p>
<pre><code class="lang-html">/donations/566593d087282d5d60eedc22/votes</code></pre>
<h3>The Request</h3>
<p><img src="../lab03/images/lab02s507.png" alt=""></p>
<h3>The Response</h3>
<p>BEFORE</p>
<p><img src="../lab03/images/lab02s506.png" alt=""></p>
<p>AFTER</p>
<p><img src="../lab03/images/lab02s508.png" alt=""></p>
<p>GET all donations again to confirm the update</p>
<p><img src="../lab03/images/lab02s509.png" alt=""></p>
<hr>

      </div>
     
      <div  class="ui tab segment lab" data-tab="06">
        <h1>Step 6 - Updating our &#39;Views&#39;</h1>
<p>If you go ahead and try and delete or upvote a &#39;donation&#39; you&#39;ll probably get some kind of error - and it&#39;s to do with the parameter we&#39;re passing to our &#39;delete&#39; and &#39;incrementVotes&#39; functions on the client side (in our .ejs file) - it&#39;s the wrong one.</p>
<p>To fix this, you first need to identify what is the <strong><em>right</em></strong> parameter to pass so you need to find out what is being sent in the response JSON string to the &#39;List All Donations&#39; request.</p>
<p>Type the following in your browser and see can you work it out?</p>
<pre><code>http://localhost:3000/donations</code></pre>
<p>Now, you simply need to change the current parameter being passed to the one that <strong><em>mongo</em></strong> uses to uniquely identify an object in its collections.</p>
<p>Restart your server and give it another go and see how you get on?</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="Solution">
        <h1>Solution - Lab 3</h1>
<p>You can find the solution to this lab <strong><a href="../zips/donationweb-2.0.zip">here</a></strong>.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab=".">
        
      </div>
     
    </div>
  </div>
</div>
  <div class="ui bottom fixed borderless right menu">
    <div class="ui right tiny menu">
      <div class="ui mini message segment">
        David Drohan (ddrohan@wit.ie).
        <a  href="http://creativecommons.org/licenses/by-nc/4.0/" title="External link to http://creativecommons.org/licenses/by-nc/4.0/"
            target="_blank">Creative Commons License
        </a>
      </div>
    </div>
  </div>

    <footer>

    </footer>
    <script>
      
$(document).ready(function()
{
  $("img").addClass ("ui image");
  $('.ui.embed').embed();

  var images = $(".lab img");
  jQuery.each(images, function(i)  {
    if((images[i].alt).length > 0)
    {
      var div_img = $(document.createElement("div")).addClass("ui segment");
      $(images[i]).wrap(div_img);
      var div_label = $(document.createElement("div")).addClass("ui ribbon teal top attached label");
      div_label.append(images[i].alt);
      $(div_label).insertBefore(images[i]);
    }
  });


  $('.ui.menu .item')
      .tab({
        history: true,
        historyType: 'hash',
      });

  $('.popup').popup();

  $('.ui.sidebar')
      .sidebar({ context: $('.pushable') })
      .sidebar('setting', 'transition', 'slide out')
      .sidebar('attach events', '#toc');
});

    </script>
  </body>

 </html>